!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("prosemirror-state"),require("prosemirror-model"),require("prosemirror-transform"),require("prosemirror-collab")):"function"==typeof define&&define.amd?define(["exports","prosemirror-state","prosemirror-model","prosemirror-transform","prosemirror-collab"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).FirebaseEditor={},e.prosemirrorState,e.prosemirrorModel,e.prosemirrorTransform,e.prosemirrorCollab)}(this,(function(e,t,o,s,r){"use strict";const{compressStepsLossy:n,compressStateJSON:i,uncompressStateJSON:c,compressSelectionJSON:l,uncompressSelectionJSON:a,compressStepJSON:d,uncompressStepJSON:f}=require("prosemirror-compress"),p={".sv":"timestamp"};e.FirebaseEditor=class{changesRef;checkpointRef;selectionsRef;selfSelectionRef;selections;view;constructor({firebaseRef:e,stateConfig:h,view:m,clientID:u=e.push().key,progress:S=(()=>{})}){S(0);const b=this,y=this.checkpointRef=e.child("checkpoint"),v=this.changesRef=e.child("changes"),g=this.selectionsRef=e.child("selections"),N=this.selfSelectionRef=g.child(u);N.onDisconnect().remove();const O=this.selections={},R={};let J;const k=y.once("value").then((e=>{S(.5);let{d:k,k:w=-1}=e.val()||{};function C(e){return s.Step.fromJSON(h.schema,f(e))}function _({docChanged:e,mapping:t},o){if(e)for(const e in O)({}).hasOwnProperty.call(O,e)&&(O[e]=O[e].map(o.doc,t));const s=r.sendableSteps(o);if(s){const{steps:e,clientID:t}=s;v.child(w+1).transaction((o=>{if(!o)return R[w+1]=e,{s:n(e).map((e=>d(e.toJSON()))),c:t,t:p}}),((e,t,r)=>{const{key:n}=r||{};if(e||!n)console.error("updateCollab",e,s,n);else if(t&&Number(n)%100==0&&Number(n)>0){const{d:e}=i(o.toJSON());y.set({d:e,k:n,t:p})}}),!1)}!o.selection.eq(J)&&(J=o.selection,N.set(l(J.toJSON())))}return w=Number(w),h.doc=k&&o.Node.fromJSON(h.schema,c({d:k}).doc),h.plugins=(h.plugins||[]).concat(r.collab({clientID:u})),v.startAt(null,String(w+1)).once("value").then((e=>{S(1);const o=b.view=m({stateConfig:h,updateCollab:_,selections:O}),s=o.editor||o,n=e.val();if(n){const e=[],t=[],o=`_oldClient${Math.random()}`,i=Object.keys(n).map(Number);w=Math.max(...i);for(const s of i){const r=n[s].s;e.push(...r.map(C)),t.push(...new Array(r.length).fill(o))}s.dispatch(r.receiveTransaction(s.state,e,t))}function i(e){const o=e.key;if(o!==u){const r=e.val();if(r)try{O[o]=t.Selection.fromJSON(s.state.doc,a(r))}catch(e){console.warn("updateClientSelection",e)}else delete O[o];s.dispatch(s.state.tr)}}return g.on("child_added",i),g.on("child_changed",i),g.on("child_removed",i),v.startAt(null,String(w+1)).on("child_added",(e=>{w=Number(e.key);const{s:t,c:o}=e.val(),n=o===u?R[w]:t.map(C),i=new Array(n.length).fill(o);s.dispatch(r.receiveTransaction(s.state,n,i)),delete R[w]})),{destroy:b.destroy.bind(b),...b}}))}));Object.defineProperties(this,{then:{value:k.then.bind(k)},catch:{value:k.catch.bind(k)}})}async destroy(){this.catch((e=>e)).then((()=>{this.changesRef.off(),this.selectionsRef.off(),this.selfSelectionRef.off(),this.selfSelectionRef.remove(),this.view.destroy()}))}catch(){throw new Error("Method not implemented.")}},Object.defineProperty(e,"__esModule",{value:!0})}));//# sourceMappingURL=index.umd.js.map
