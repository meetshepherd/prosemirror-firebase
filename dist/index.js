"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("prosemirror-state"),t=require("prosemirror-model"),s=require("prosemirror-transform"),o=require("prosemirror-collab");const{compressStepsLossy:c,compressStateJSON:n,uncompressStateJSON:r,compressSelectionJSON:i,uncompressSelectionJSON:l,compressStepJSON:a,uncompressStepJSON:h}=require("prosemirror-compress"),d={".sv":"timestamp"};exports.FirebaseEditor=class{changesRef;checkpointRef;selectionsRef;selfSelectionRef;selections;view;constructor({firebaseRef:f,stateConfig:p,view:m,clientID:u=f.push().key,progress:S=(()=>{})}){S(0);const v=this,b=this.checkpointRef=f.child("checkpoint"),N=this.changesRef=f.child("changes"),g=this.selectionsRef=f.child("selections"),y=this.selfSelectionRef=g.child(u);y.onDisconnect().remove();const O=this.selections={},R={};let J;const k=b.once("value").then((f=>{S(.5);let{d:k,k:w=-1}=f.val()||{};function C(e){return s.Step.fromJSON(p.schema,h(e))}function _({docChanged:e,mapping:t},s){if(e)for(const e in O)({}).hasOwnProperty.call(O,e)&&(O[e]=O[e].map(s.doc,t));const r=o.sendableSteps(s);if(r){const{steps:e,clientID:t}=r;N.child(w+1).transaction((s=>{if(!s)return R[w+1]=e,{s:c(e).map((e=>a(e.toJSON()))),c:t,t:d}}),((e,t,o)=>{const{key:c}=o||{};if(e||!c)console.error("updateCollab",e,r,c);else if(t&&Number(c)%100==0&&Number(c)>0){const{d:e}=n(s.toJSON());b.set({d:e,k:c,t:d})}}),!1)}!s.selection.eq(J)&&(J=s.selection,y.set(i(J.toJSON())))}return w=Number(w),p.doc=k&&t.Node.fromJSON(p.schema,r({d:k}).doc),p.plugins=(p.plugins||[]).concat(o.collab({clientID:u})),N.startAt(null,String(w+1)).once("value").then((t=>{S(1);const s=v.view=m({stateConfig:p,updateCollab:_,selections:O}),c=s.editor||s,n=t.val();if(n){const e=[],t=[],s=`_oldClient${Math.random()}`,r=Object.keys(n).map(Number);w=Math.max(...r);for(const o of r){const c=n[o].s;e.push(...c.map(C)),t.push(...new Array(c.length).fill(s))}c.dispatch(o.receiveTransaction(c.state,e,t))}function r(t){const s=t.key;if(s!==u){const o=t.val();if(o)try{O[s]=e.Selection.fromJSON(c.state.doc,l(o))}catch(e){console.warn("updateClientSelection",e)}else delete O[s];c.dispatch(c.state.tr)}}return g.on("child_added",r),g.on("child_changed",r),g.on("child_removed",r),N.startAt(null,String(w+1)).on("child_added",(e=>{w=Number(e.key);const{s:t,c:s}=e.val(),n=s===u?R[w]:t.map(C),r=new Array(n.length).fill(s);c.dispatch(o.receiveTransaction(c.state,n,r)),delete R[w]})),{destroy:v.destroy.bind(v),...v}}))}));Object.defineProperties(this,{then:{value:k.then.bind(k)},catch:{value:k.catch.bind(k)}})}async destroy(){this.catch((e=>e)).then((()=>{this.changesRef.off(),this.selectionsRef.off(),this.selfSelectionRef.off(),this.selfSelectionRef.remove(),this.view.destroy()}))}catch(){throw new Error("Method not implemented.")}};//# sourceMappingURL=index.js.map
